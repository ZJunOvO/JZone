# 测试计划（jzone-player）

## 1. 测试目标与范围

- 覆盖关键业务流：点歌播放、暂停继续、上一首/下一首、裁剪循环、队列管理、评论时间点跳转、上传与裁剪保存
- 验证边界与异常：空队列、seek 越界、音频加载失败、快速切歌、移动端触摸拖拽
- 验证非功能项：性能（重渲染/卡顿）、安全（秘钥暴露与第三方资源风险）

不在范围（当前仓库现状）：登录鉴权、后端 API、付费/权限、跨设备同步。

## 2. 测试策略

### 2.1 单元测试（Unit）

重点：纯逻辑与可抽离逻辑。

- 队列算法：next/prev、removeFromQueue 后的行为
- 时间区间：trimStart/trimEnd、seek/clamp 规则、进度百分比计算
- 评论：过滤排序、anchorTime 生成规则与重置规则

建议实现方式（可选）：

- 将音频控制从 React Context 抽象为 `AudioManager`，并在单测中用 mock 替代真实 `HTMLAudioElement`

### 2.2 集成测试（Integration）

重点：store + 组件交互。

- 点击歌曲后，UI 更新与播放状态一致
- 打开全屏播放器后，进度条/音量条能够驱动 store
- 评论跳转会更新当前时间

### 2.3 端到端测试（E2E）

重点：用户操作路径与关键回归。

工具建议：Playwright（移动端视口）或 Cypress。

## 3. 核心场景清单

### 3.1 播放器

- 播放/暂停：从首页、资料库、上传列表进入
- 切歌：next/prev；队列为空、只有一首、当前不在队列等情况
- 进度条：拖动 seek；seek 到 trimStart/trimEnd 边界；快速连续 seek
- 裁剪循环：播放到 trimEnd 会回到 trimStart；切歌后循环逻辑正确重置
- 音量：0、1、连续拖动；移动端触摸拖动

### 3.2 队列

- 打开队列抽屉：展示顺序与当前播放标识正确
- 从队列移除：移除当前播放曲目、移除非当前曲目；移除后 next/prev 行为正确

### 3.3 评论

- 展示：按 songId 过滤正确；排序按 timestamp 倒序正确
- 发送：空文本不可提交；提交后列表更新；anchorTime 清空
- 时间点跳转：点击时间徽章后跳转；越界时间点处理

### 3.4 上传

- 选择音频：进入 step 2；自动提取文件名元数据
- 裁剪：拖拽 IN/OUT；IN < OUT；最小时长限制
- 保存：新增歌曲出现在资料库与“我的上传”；点击可播放
- 封面：选择图片后替换；图片加载失败兜底

## 4. 边界条件与异常情况

- 音频加载失败/跨域失败：UI 提示、不会卡死在 playing 状态
- 快速切歌：连续点击不同歌曲不会抛异常；不会出现状态错乱
- duration 异常：metadata 未加载时 duration 为 NaN/Infinity 的保护
- 大量歌曲：资料库 canvas 性能与滚动/拖拽稳定性

## 5. 测试用例示例（示范）

### 用例：点击歌曲开始播放

- 前置：应用首次打开，存在至少 1 首歌曲
- 步骤：在“现在就听”点击任意歌曲卡片
- 期望：
  - 迷你播放器出现并展示该歌曲标题/艺人
  - 播放状态为播放中（按钮为 Pause）
  - 进入全屏播放器后信息一致

### 用例：裁剪循环生效

- 前置：存在 trimStart=10，trimEnd=12 的歌曲（或上传创建）
- 步骤：播放该歌曲并等待超过 12 秒
- 期望：
  - 当前时间会回到约 10 秒附近继续播放
  - UI 进度条不会出现 NaN/跳动异常

